var LEAUI_DATAS=[];tinymce.PluginManager.add("leaui_image",function(e,t){function n(e,t){function n(e,n){r.parentNode.removeChild(r),t({width:e,height:n})}var r=document.createElement("img");r.onload=function(){n(r.clientWidth,r.clientHeight)},r.onerror=function(){n()},r.src=e;var i=r.style;i.visibility="hidden",i.position="fixed",i.bottom=i.left=0,i.width=i.height="auto",document.body.appendChild(r)}function r(){function t(){var e='<iframe id="leauiIfr" src="/album/index?'+(new Date).getTime()+'" frameborder="0"></iframe>';return e}var r=e.dom,i=e.selection.getContent(),o=/<img.*?\/>/g,a=i.match(o),s=document.createElement("p"),l=[];for(var c in a){s.innerHTML=a[c];var d=s.firstChild;if(d&&"IMG"==d.nodeName){var u={};u.src=r.getAttrib(d,"data-src")||r.getAttrib(d,"src"),u.width=r.getAttrib(d,"width"),u.height=r.getAttrib(d,"height"),u.title=r.getAttrib(d,"title"),l.push(u)}}LEAUI_DATAS=l;var f=$(document).width()-10;f>805&&(f=805);var p=$(document).height()-100;p>365&&(p=365),win=e.windowManager.open({title:"Image",width:f,height:p,html:t(),buttons:[{text:"Cancel",onclick:function(){this.parent().parent().close()}},{text:"Insert Image",subtype:"primary",onclick:function(t){for(var i=document.getElementById("leauiIfr").contentWindow,o=i.document.getElementById("preview"),a=o.childNodes,s=[],l=0;l<a.length;++l){var t=a[l];if(t.firstChild&&"IMG"==t.firstChild.nodeName){var c=t.firstChild,d={};d.src=c.getAttribute("src"),d.width=c.getAttribute("data-width"),d.height=c.getAttribute("data-height"),d.title=c.getAttribute("data-title"),s.push(d)}}for(var l in s){var u=s[l],f=u.src,p=f;u.src=f;var h=function(t){var i=function(t,n){var i,o={};return o.id="__mcenew"+n,o.src="/images/loading-24.gif",i=r.createHTML("img",o),e.insertContent(i),i=r.get(o.id),function(e){e&&e.width&&(e.width>600&&(e.width=600),t.width=e.width),r.setAttrib(i,"src",t.src),r.setAttrib(i,"title",t.title),r.setAttrib(i,"id",null)}}(t,l);n(t.src,i)},m="";if(fileIds=p.split("fileId="),2==fileIds.length&&fileIds[1].length=="53aecf8a8a039a43c8036282".length&&(m=fileIds[1]),m){var g;Note&&Note.getCurNote&&(g=Note.getCurNote()),g&&g.UserId!=UserInfo.UserId?!function(e){ajaxPost("/file/copyImage",{userId:UserInfo.UserId,fileId:m,toUserId:g.UserId},function(t){reIsOk(t)&&t.Id&&(e.src="/api/file/getImage?fileId="+t.Id),h(e)})}(u):h(u)}else h(u)}this.parent().parent().close()}}]})}e.addButton("leaui_image",{icon:"image",tooltip:"Insert/edit image",onclick:r,stateSelector:"img:not([data-mind-json])"}),e.addMenuItem("leaui_image",{icon:"image",text:"Insert image",onclick:r,context:"insert",prependToContext:!0});var i=!1;e.on("dragstart",function(e){LEA.readOnly&&(e.preventDefault(),e.stopPropagation()),i=!0}),e.on("dragend",function(e){i=!1}),e.on("dragover",function(e){i&&(e.preventDefault(),e.stopPropagation())})});