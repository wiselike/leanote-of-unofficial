tinymce.PluginManager.add("leanote_code",function(e,t){function n(e){return e?("object"==typeof e&&(e=$(e).html()),e.replace(/\<br *\/*\>/gi,"\n").replace(/<\/(p|li|div|ul|ol|hr)>/,"\n").replace(/(<([^>]+)>)/gi,"").replace(/\n\n/g,"\n")):e}function r(e){return e?("object"==typeof e&&(e=$(e).html()),e.replace(/\n/g,"<br />")):e}function i(){var e=$("#editorContent").children(),t=e&&e.length>0?e[e.length-1]:null;t&&"P"==t.tagName||$("#editorContent").append('<p><br data-mce-bogus="1"></p>')}function o(e){if(!LEA.readOnly){s=tinymce.activeEditor;var t,o=s.selection.getNode(),a=s.selection.getContent(),l=LeaAce.isInAce(o),c=!1,d=!1;l&&(c=l[0],d=l[1]),$("#editorContent .toggle-raw").remove();var u='class="brush:'+e+'"';if(e&&"convert"!=e){if(c&&c.session.setMode("ace/mode/"+e),d||"PRE"!=o.nodeName||(d=$(o)),d){var f=LeaAce.getPreBrush(d);return void d.removeClass(f).addClass("brush:"+e)}}else if(e&&("BODY"==o.nodeName||"editorContent"==$(o).attr("id")))return;if(LeaAce.canAce()){var p=LeaAce.getAceId();if(LeaAce.disableAddHistory(),c){var m=c.getValue();m=m.replace(/</g,"&lt;"),m=m.replace(/>/g,"&gt;"),m=m.replace(/\n/g,"<br />"),d.replaceWith("<p>"+m+"</p>"),c.destroy()}else{if("PRE"==o.nodeName){var d=$(o),m=d.html();return m&&(m=m.replace(/\n/g,"<br />")),void d.replaceWith("<p>"+m+"</p>")}var t=a;if(!t&&("BODY"==o.nodeName||"editorContent"==$(o).attr("id")))return;t?(t=n(t),s.insertContent('<pre id="'+p+'" '+u+">"+t+"</pre>")):(t=n(o),$(o).replaceWith("<pre id='"+p+"'"+u+">"+t+"</pre>"));var c=LeaAce.initAce(p);c&&(c.focus(),e&&"convert"!=e&&c.session.setMode("ace/mode/"+e),i())}LeaAce.resetAddHistory()}else if("PRE"!=o.nodeName&&(o=$(o).closest("pre").get(0)),o&&"PRE"==o.nodeName){var d=$(o),m=d.html();m&&(m=m.replace(/\n/g,"<br />")),d.replaceWith("<p>"+m+"</p>")}else{try{t=$.trim($(a).text())}catch(e){}t||(t=$.trim(a));var h=null,p=LeaAce.getAceId();t?(t=r(t),h='<pre id="'+p+'" '+u+">"+t+"</pre>",s.insertContent(h)):o?(t=r(o),h='<pre id="'+p+'" '+u+">"+t+"</pre>",$(o).replaceWith(h)):(h='<pre id="'+p+'" '+u+">"+t+"</pre>",s.insertContent(h)),h&&i()}}}function a(){return function(){var t=this;e.on("nodeChange",function(){var n=null;try{var r=e.selection.getNode();if("PRE"!=r.nodeName&&(r=$(r).closest("pre").get(0)),r){var i=LeaAce.isInAce(r),o=!1,a=!1;if(i||"PRE"==r.nodeName){i?(o=i[0],a=i[1]):a=$(r);var s=LeaAce.getPreBrush(a);n=$.trim(s.split(":")[1]),t.diableValue("convert",!1)}else t.diableValue("convert",!0)}}catch(e){log(e)}"convert"!=n&&t.value(n)})}}var s=e;e.addButton("leanote_code",function(){var e=["Convert Code:convert","CSS:css","HTML:html","Javascript:javascript","C/C++:c_cpp","C#:csharp","Java:java","Objective-c:objectivec","PHP:php","Python:python","Ruby:ruby","Shell:sh","Delphi:delphi","Golang:golang","Erlang:erlang","Groovy:groovy","Latex:latex","Xml:xml","ActionScript:actionScript"],t=[];for(var n in e){var r=e[n].split(":");t.push({text:r[0],value:r[1]})}return{type:"listbox",text:"Language",tooltip:"`ctrl/cmd+shift+c` toggle code",values:t,fixedWidth:!0,onselect:function(e){e.control.settings.value&&o(e.control.settings.value)},onPostRender:a(t)}}),e.addButton("leanote_inline_code",{icon:"code",tooltip:"Inline Code",stateSelector:"code",onclick:function(){e.execCommand("mceToggleFormat",!1,"code")}}),LeaAce.canAce()&&e.addButton("leanote_ace_pre",{icon:"ace-pre",tooltip:"Toggle ace with raw html",active:LeaAce.isAce===!1,onclick:function(){LeaAce.isAce===!1?(this.active(!1),LeaAce.isAce=!0,LeaAce.initAceFromContent(e)):(this.active(!0),LeaAce.allToPre(e),LeaAce.isAce=!1)}}),s.addCommand("toggleCode",o),s.addShortcut("ctrl+shift+c","","toggleCode"),s.addShortcut("meta+shift+c","","toggleCode"),LeaAce.canAce()&&e.on("keydown",function(e){var t=LeaAce.nowIsInAce();if(t)return setTimeout(function(){t[0].focus()}),!0}),s.on("keydown",function(e){var t=e.which?e.which:e.keyCode;if(9==t&&!e.shiftKey){var n=s.selection.getNode();return!(!n||!("LI"==n.nodeName||$(n.closest("li")).length>0))||(s.insertContent("&nbsp;&nbsp;&nbsp;&nbsp;"),e.preventDefault(),e.stopPropagation(),!1)}})});